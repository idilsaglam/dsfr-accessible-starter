# /opt/bitnami/nginx/conf/nginx.conf
# Hardened NGINX config for serving a React SPA on Bitnami NGINX (port 8080)

worker_processes  auto;

events {
  worker_connections  1024;
  # Mitigate slowloris-style attacks
  multi_accept        on;
  use                 epoll;
}

http {
  include             mime.types;
  default_type        application/octet-stream;

  # Hide NGINX version
  server_tokens       off;

  # Logs (adjust paths if you rotate elsewhere)
  access_log          /opt/bitnami/nginx/logs/access.log;
  error_log           /opt/bitnami/nginx/logs/error.log warn;

  # Sensible timeouts & keepalive
  sendfile            on;
  tcp_nodelay         on;
  tcp_nopush          on;
  keepalive_timeout   25s;
  keepalive_requests  100;
  client_body_timeout 10s;
  client_header_timeout 10s;
  send_timeout        10s;

  # Limit request size (raise if you upload large files via the SPA)
  client_max_body_size 10m;

  # Compression (safe defaults for text assets)
  gzip                on;
  gzip_comp_level     5;
  gzip_min_length     1024;
  gzip_proxied        any;
  gzip_vary           on;
  gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/rss+xml
    application/vnd.ms-fontobject
    application/font-woff
    application/font-woff2
    font/ttf
    font/otf
    image/svg+xml;

  # Cache small open file metadata to reduce IO
  open_file_cache          max=1000 inactive=60s;
  open_file_cache_valid    60s;
  open_file_cache_min_uses 2;
  open_file_cache_errors   on;

  # Default Server: React build served from /app
  server {
    listen       8080 default_server;
    server_name  _;
    root         /app;                 # Mount your React build here (contains index.html)
    index        index.html;

    # Security headers
    # Adjust CSP to your needs; this is a minimal, SPA-friendly baseline.
    # For modern React apps, 'unsafe-inline' for styles and 'unsafe-eval' for scripts may be required.
    # If you use a stricter build (no inline styles/eval), you may remove these.
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; font-src 'self' data:; connect-src 'self' https: wss:;" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(*), payment=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # Health check (optional)
    location = /healthz {
      access_log off;
      add_header Content-Type text/plain;
      return 200 "ok\n";
    }


    # Deny access to hidden files and control files
    location ~ /\.(?!well-known) {
      deny all;
      access_log off;
      log_not_found off;
    }

    # Don’t serve source maps publicly, or serve with short cache (choose one)
    # Here: serve, but short cache to help debugging in production if needed.
    location ~* \.map$ {
      limit_except GET HEAD OPTIONS {
        deny all;
      }
      types { application/json map; }
      add_header Cache-Control "public, max-age=300";
      try_files $uri =404;
    }

    # Long cache immutable for hashed static assets (JS/CSS with hashes)
    location ~* \.(?:js|css)$ {
      limit_except GET HEAD OPTIONS {
        deny all;
      }
      # If your build uses content hashes (e.g., main.abc123.js), mark immutable
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri =404;
    }

    # Cache other static assets aggressively
    location ~* \.(?:png|jpe?g|gif|webp|avif|svg|ico|ttf|otf|woff|woff2)$ {
      limit_except GET HEAD OPTIONS {
        deny all;
      }
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri =404;
      access_log off;
    }

    # SPA fallback: serve index.html for routes that don’t map to a file
    location / {
      limit_except GET HEAD OPTIONS {
        deny all;
      }
      # Never cache index.html — ensures new deployments are picked up quickly
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      try_files $uri $uri/ /index.html;
    }

    # Optional: Strict transport security if you terminate TLS here on 8443
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
  }
}